---
import { getCollection } from "astro:content";
import { siteConfig } from "../../config";
import { PAGE_SIZE } from "../../constants/constants";
import { formatDateToYYYYMMDD } from "../../utils/date-utils";
import { getPostUrlBySlug, url } from "../../utils/url-utils";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const className = Astro.props.class;
const style = Astro.props.style;

const posts = await getCollection("posts", ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
});

const postCount = posts.length;

let lastUpdatedAt: Date | null = null;
for (const post of posts) {
	const updatedAt = post.data.updated ?? post.data.published;
	if (!lastUpdatedAt || updatedAt.getTime() > lastUpdatedAt.getTime()) {
		lastUpdatedAt = updatedAt;
	}
}

const lastUpdatedText = lastUpdatedAt
	? formatDateToYYYYMMDD(lastUpdatedAt)
	: "-";
const siteStartMs = new Date(siteConfig.launchDate).getTime();
const walineServerURL = siteConfig.waline?.serverURL;
const walinePageviewEnabled = siteConfig.waline?.pageview ?? false;
const normalizeForWaline = (pathname: string) => {
	if (!pathname) return "/";
	if (pathname !== "/" && pathname.endsWith("/")) return pathname.slice(0, -1);
	return pathname;
};
const totalPages = Math.ceil(postCount / PAGE_SIZE);
const allPageviewPaths = Array.from(
	new Set(
		[
			url("/"),
			url("/archive/"),
			url("/about/"),
			...Array.from({ length: Math.max(0, totalPages - 1) }, (_, i) =>
				url(`/${i + 2}/`),
			),
			...posts.map((post) => getPostUrlBySlug(post.slug)),
		].map(normalizeForWaline),
	),
);
---

<WidgetLayout
	name="网站资讯"
	id="site-info"
	class={className}
	style={style}
>
	<div class="flex flex-col gap-3">
		<div class="flex items-center justify-between gap-4">
			<div class="text-50 text-sm font-medium">文章数</div>
			<div class="text-75 text-sm font-bold">{postCount}</div>
		</div>
		<div class="flex items-center justify-between gap-4">
			<div class="text-50 text-sm font-medium">总浏览数</div>
			<div class="text-75 text-sm font-bold">
				<span id="site-total-pageviews">-</span>
			</div>
		</div>
		<div class="flex items-center justify-between gap-4">
			<div class="text-50 text-sm font-medium">运行时间</div>
			<div class="text-75 text-sm font-bold">
				<span id="site-running-time"></span>
			</div>
		</div>
		<div class="flex items-center justify-between gap-4">
			<div class="text-50 text-sm font-medium">最后更新</div>
			<div class="text-75 text-sm font-bold">{lastUpdatedText}</div>
		</div>
	</div>
</WidgetLayout>

<div id="site-total-pageviews-source" class="hidden">
	{allPageviewPaths.map((p) => (
		<span class="waline-pageview-count" data-path={p}>-</span>
	))}
</div>

<style is:global>
	body:not(.is-home) widget-layout[data-id="site-info"] {
		display: none;
	}
</style>

<script is:inline define:vars={{ siteStartMs, walineServerURL, walinePageviewEnabled }}>
	function formatUptime(ms) {
		const totalSeconds = Math.max(0, Math.floor(ms / 1000));
		const days = Math.floor(totalSeconds / 86400);
		const hours = Math.floor((totalSeconds % 86400) / 3600);
		const minutes = Math.floor((totalSeconds % 3600) / 60);
		if (days > 0) return `${days} 天 ${hours} 小时`;
		if (hours > 0) return `${hours} 小时 ${minutes} 分钟`;
		return `${minutes} 分钟`;
	}

	function renderUptime() {
		const el = document.getElementById("site-running-time");
		if (!el) return;
		el.textContent = formatUptime(Date.now() - siteStartMs);
	}

	renderUptime();
	setInterval(renderUptime, 60 * 1000);

	const parseCount = (text) => {
		const v = String(text ?? "").replace(/[^\d]/g, "");
		if (!v) return null;
		const n = Number.parseInt(v, 10);
		return Number.isFinite(n) ? n : null;
	};

	const renderTotalPageviews = () => {
		const output = document.getElementById("site-total-pageviews");
		const source = document.getElementById("site-total-pageviews-source");
		if (!output || !source) return;

		const nodes = source.querySelectorAll(".waline-pageview-count");
		let total = 0;
		let hasValue = false;
		for (const node of nodes) {
			const n = parseCount(node.textContent);
			if (n === null) continue;
			hasValue = true;
			total += n;
		}

		if (hasValue) output.textContent = String(total);
	};

	const normalizePathname = (pathname) => {
		if (!pathname) return "/";
		if (pathname !== "/" && pathname.endsWith("/")) return pathname.slice(0, -1);
		return pathname;
	};

	const updatePageviews = async () => {
		if (!walinePageviewEnabled || !walineServerURL) return;
		if (!document.querySelector(".waline-pageview-count")) return;

		window.__walinePageviewCountConfig = {
			serverURL: walineServerURL,
			enabled: walinePageviewEnabled,
		};

		try {
			window.__walinePageviewCountAbort?.();
		} catch {}

		const module = await import("https://unpkg.com/@waline/client@v3/dist/pageview.js");
		const path = normalizePathname(window.location.pathname);
		window.__walinePageviewCountAbort = module.pageviewCount?.({
			serverURL: walineServerURL,
			path,
			update: false,
		});
	};

	const setupTotalPageviewsObserver = () => {
		if (window.__walineTotalPageviewsObserverAdded) return;
		window.__walineTotalPageviewsObserverAdded = true;

		const source = document.getElementById("site-total-pageviews-source");
		if (!source) return;

		const observer = new MutationObserver(() => renderTotalPageviews());
		observer.observe(source, {
			childList: true,
			subtree: true,
			characterData: true,
		});
		window.__walineTotalPageviewsObserver = observer;
	};

	const onReady = () => {
		if (!document.body.classList.contains("is-home")) return;
		setupTotalPageviewsObserver();
		updatePageviews();
		renderTotalPageviews();
	};

	document.addEventListener("astro:page-load", onReady);
	if (document.readyState === "complete" || document.readyState === "interactive") {
		onReady();
	} else {
		document.addEventListener("DOMContentLoaded", onReady);
	}
	if (window?.swup?.hooks) {
		window.swup.hooks.on("page:view", onReady);
	}
</script>
