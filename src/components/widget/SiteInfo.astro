---
import { getCollection } from "astro:content";
import { siteConfig } from "../../config";
import { formatDateToYYYYMMDD } from "../../utils/date-utils";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const className = Astro.props.class;
const style = Astro.props.style;

const posts = await getCollection("posts", ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
});

const postCount = posts.length;

let lastUpdatedAt: Date | null = null;
for (const post of posts) {
	const updatedAt = post.data.updated ?? post.data.published;
	if (!lastUpdatedAt || updatedAt.getTime() > lastUpdatedAt.getTime()) {
		lastUpdatedAt = updatedAt;
	}
}

const lastUpdatedText = lastUpdatedAt
	? formatDateToYYYYMMDD(lastUpdatedAt)
	: "-";
const siteStartMs = new Date(siteConfig.launchDate).getTime();

const UMAMI_HOST = import.meta.env.UMAMI_HOST ?? "https://analytics.xhwen.cn";
const UMAMI_WEBSITE_ID =
	import.meta.env.UMAMI_WEBSITE_ID ?? "1622d120-0aaa-4728-804b-0a719cdeef93";
const UMAMI_TOKEN = import.meta.env.UMAMI_TOKEN;
const UMAMI_USERNAME = import.meta.env.UMAMI_USERNAME;
const UMAMI_PASSWORD = import.meta.env.UMAMI_PASSWORD;

const getUmamiToken = async () => {
	const g = globalThis;
	const anyG = g as unknown as Record<string, unknown>;
	const key = "__umamiAuthTokenPromiseV1";
	const existing = anyG[key] as Promise<string | null> | undefined;
	if (existing) return existing;

	const p = (async () => {
		if (UMAMI_TOKEN) return UMAMI_TOKEN;
		if (!UMAMI_USERNAME || !UMAMI_PASSWORD) return null;

		try {
			const res = await fetch(new URL("/api/auth/login", UMAMI_HOST), {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({
					username: UMAMI_USERNAME,
					password: UMAMI_PASSWORD,
				}),
			});
			if (!res.ok) return null;
			const data = (await res.json()) as { token?: string };
			return data.token ?? null;
		} catch {
			return null;
		}
	})();

	anyG[key] = p;
	return p;
};

const getUmamiTotalPageviews = async () => {
	const g = globalThis as unknown as Record<string, unknown>;
	const key = "__umamiTotalPageviewsPromiseV1";
	const existing = g[key] as Promise<number | null> | undefined;
	if (existing) return existing;

	const p = (async () => {
		const token = await getUmamiToken();
		if (!token) return null;
		const endAt = Date.now();
		const startAt = Number.isFinite(siteStartMs) ? siteStartMs : 0;

		const u = new URL(`/api/websites/${UMAMI_WEBSITE_ID}/stats`, UMAMI_HOST);
		u.searchParams.set("startAt", String(startAt));
		u.searchParams.set("endAt", String(endAt));

		try {
			const res = await fetch(u, {
				headers: { Authorization: `Bearer ${token}` },
			});
			if (!res.ok) return null;
			const data = (await res.json()) as { pageviews?: number };
			const n = Number(data.pageviews);
			return Number.isFinite(n) ? n : null;
		} catch {
			return null;
		}
	})();

	g[key] = p;
	return p;
};

const totalPageviews = await getUmamiTotalPageviews();
const totalPageviewsText =
	typeof totalPageviews === "number" ? String(totalPageviews) : "-";
---

<WidgetLayout
	name="网站资讯"
	id="site-info"
	class={className}
	style={style}
>
	<div class="flex flex-col gap-3">
		<div class="flex items-center justify-between gap-4">
			<div class="text-50 text-sm font-medium">文章数</div>
			<div class="text-75 text-sm font-bold">{postCount}</div>
		</div>
		<div class="flex items-center justify-between gap-4">
			<div class="text-50 text-sm font-medium">总浏览数</div>
			<div class="text-75 text-sm font-bold">
				<span id="site-total-pageviews">{totalPageviewsText}</span>
			</div>
		</div>
		<div class="flex items-center justify-between gap-4">
			<div class="text-50 text-sm font-medium">运行时间</div>
			<div class="text-75 text-sm font-bold">
				<span id="site-running-time"></span>
			</div>
		</div>
		<div class="flex items-center justify-between gap-4">
			<div class="text-50 text-sm font-medium">最后更新</div>
			<div class="text-75 text-sm font-bold">{lastUpdatedText}</div>
		</div>
	</div>
</WidgetLayout>

<style is:global>
	body:not(.is-home) widget-layout[data-id="site-info"] {
		display: none;
	}
</style>

<script is:inline define:vars={{ siteStartMs }}>
	function formatUptime(ms) {
		const totalSeconds = Math.max(0, Math.floor(ms / 1000));
		const days = Math.floor(totalSeconds / 86400);
		const hours = Math.floor((totalSeconds % 86400) / 3600);
		const minutes = Math.floor((totalSeconds % 3600) / 60);
		if (days > 0) return `${days} 天 ${hours} 小时`;
		if (hours > 0) return `${hours} 小时 ${minutes} 分钟`;
		return `${minutes} 分钟`;
	}

	function renderUptime() {
		const el = document.getElementById("site-running-time");
		if (!el) return;
		el.textContent = formatUptime(Date.now() - siteStartMs);
	}

	renderUptime();
	setInterval(renderUptime, 60 * 1000);
</script>
